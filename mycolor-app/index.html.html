<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyColor - 퍼스널컬러 매칭 서비스</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding-top: 20px;
        }

        .logo {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .subtitle {
            font-size: 14px;
            opacity: 0.95;
        }

        .powered-by {
            font-size: 11px;
            opacity: 0.8;
            margin-top: 5px;
        }

        .main-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .personal-color-selector {
            margin-bottom: 30px;
        }

        .pc-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 12px;
            font-weight: 500;
        }

        .pc-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .pc-option {
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
        }

        .pc-option:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .pc-option.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }

        .spring { background: linear-gradient(45deg, #FFE4E1, #FFA07A); }
        .summer { background: linear-gradient(45deg, #E6E6FA, #B0C4DE); }
        .autumn { background: linear-gradient(45deg, #DEB887, #D2691E); }
        .winter { background: linear-gradient(45deg, #F0F8FF, #4682B4); }

        .pc-option.selected.spring,
        .pc-option.selected.summer,
        .pc-option.selected.autumn,
        .pc-option.selected.winter {
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        .upload-section {
            text-align: center;
            padding: 40px 20px;
            border: 2px dashed #e0e0e0;
            border-radius: 16px;
            background: #fafafa;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-section:hover {
            border-color: #667eea;
            background: #f5f5ff;
        }

        .upload-section.has-image {
            padding: 20px;
            border-style: solid;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .upload-text {
            color: #666;
            font-size: 16px;
            margin-bottom: 8px;
        }

        .upload-subtext {
            color: #999;
            font-size: 14px;
        }

        #fileInput {
            display: none;
        }

        .image-preview {
            max-width: 100%;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .analyze-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .analyze-btn:hover {
            transform: translateY(-2px);
        }

        .analyze-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .loading-content {
            text-align: center;
            color: white;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .ad-placeholder {
            background: #f0f0f0;
            border: 2px dashed #ccc;
            padding: 40px 20px;
            margin: 20px 0;
            text-align: center;
            color: #999;
            border-radius: 8px;
        }

        .result-section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .result-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .match-score {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .match-score.good { color: #4CAF50; }
        .match-score.okay { color: #FF9800; }
        .match-score.bad { color: #f44336; }

        .match-message {
            font-size: 18px;
            color: #666;
            margin-bottom: 20px;
        }

        .color-analysis {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #333;
        }

        .color-palette {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .color-chip {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .color-chip:hover {
            transform: scale(1.1);
        }

        .color-chip.selected {
            transform: scale(1.15);
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
            border: 3px solid #667eea;
        }

        .color-chip.detected {
            width: 70px;
            height: 70px;
        }

        .color-chip.detected .color-match-badge {
            width: 32px;
            height: 32px;
            font-size: 11px;
        }

        .color-hex {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #666;
            white-space: nowrap;
        }

        .color-match-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: white;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .color-match-badge.good {
            color: #4CAF50;
            border: 2px solid #4CAF50;
        }

        .color-match-badge.okay {
            color: #FF9800;
            border: 2px solid #FF9800;
        }

        .color-match-badge.bad {
            color: #f44336;
            border: 2px solid #f44336;
        }

        .individual-color-info {
            background: #f8f9ff;
            padding: 16px;
            border-radius: 12px;
            margin-top: 20px;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .individual-color-info.show {
            display: block;
        }

        .color-info-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .color-info-sample {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .color-info-score {
            font-size: 24px;
            font-weight: bold;
        }

        .color-info-score.good { color: #4CAF50; }
        .color-info-score.okay { color: #FF9800; }
        .color-info-score.bad { color: #f44336; }

        .color-info-text {
            font-size: 14px;
            color: #666;
            line-height: 1.5;
        }

        .recommendation {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .retry-btn {
            width: 100%;
            padding: 14px;
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .retry-btn:hover {
            background: #667eea;
            color: white;
        }

        .ai-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .main-card {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">🎨 MyColor</div>
            <div class="subtitle">당신의 퍼스널컬러와 잘 어울리는 옷을 찾아드려요</div>
            <div class="powered-by">✨ AI 기반 정밀 색상 분석</div>
        </header>

        <div class="main-card">
            <div class="personal-color-selector">
                <div class="pc-label">나의 퍼스널컬러를 선택해주세요</div>
                <div class="pc-options">
                    <div class="pc-option spring" data-season="spring">🌸 봄웜톤</div>
                    <div class="pc-option summer" data-season="summer">💙 여름쿨톤</div>
                    <div class="pc-option autumn" data-season="autumn">🍂 가을웜톤</div>
                    <div class="pc-option winter" data-season="winter">❄️ 겨울쿨톤</div>
                </div>
            </div>

            <div class="upload-section" id="uploadSection">
                <div class="upload-icon">📸</div>
                <div class="upload-text">옷 사진을 업로드하세요</div>
                <div class="upload-subtext">클릭하거나 드래그해서 업로드</div>
                <input type="file" id="fileInput" accept="image/*">
            </div>

            <button class="analyze-btn" id="analyzeBtn" disabled>색상 분석하기</button>

            <div class="result-section" id="resultSection">
                <div class="ai-badge">🤖 AI 분석 완료</div>
                <div class="result-header">
                    <div class="match-score" id="matchScore">85%</div>
                    <div class="match-message" id="matchMessage">잘 어울려요!</div>
                    <div style="font-size: 12px; color: #999; margin-top: 8px;">전체 평균 매칭도</div>
                </div>

                <div class="color-analysis">
                    <div class="section-title">감지된 색상 (클릭하여 개별 점수 확인)</div>
                    <div class="color-palette" id="detectedColors"></div>
                    <div class="individual-color-info" id="individualColorInfo">
                        <div class="color-info-header">
                            <div class="color-info-sample" id="colorInfoSample"></div>
                            <div>
                                <div class="color-info-score" id="colorInfoScore">85%</div>
                                <div style="font-size: 12px; color: #999;" id="colorInfoHex">#FFFFFF</div>
                            </div>
                        </div>
                        <div class="color-info-text" id="colorInfoText">
                            이 색상은 당신의 퍼스널컬러와 잘 어울립니다.
                        </div>
                    </div>
                </div>

                <div class="recommendation">
                    <div class="section-title">✨ 이 색상과 잘 어울리는 당신의 퍼스널컬러</div>
                    <div class="color-palette" id="recommendedColors"></div>
                </div>

                <button class="retry-btn" id="retryBtn">다른 옷 분석하기</button>
            </div>
        </div>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div style="font-size: 18px; margin-bottom: 20px;">AI가 색상을 분석중입니다...</div>
            <div style="font-size: 12px; color: #aaa; margin-bottom: 10px;">Google Vision AI 사용 중</div>
            <div class="ad-placeholder">
                <div style="font-size: 14px;">[ 광고 영역 ]</div>
                <div style="font-size: 12px; margin-top: 10px;">Google AdSense</div>
            </div>
        </div>
    </div>

    <script>
        // API 엔드포인트 설정
        const API_ENDPOINT = '/api/analyze-colors'; // Vercel 서버리스 함수 엔드포인트
        // 개발 중에는 다음과 같이 사용:
        // const API_ENDPOINT = 'http://localhost:3000/api/analyze-colors';
        
        // 퍼스널컬러 데이터베이스
        const personalColorDB = {
            spring: {
                name: '봄웜톤',
                bestColors: ['#FFE4E1', '#FFA07A', '#FFB6C1', '#FFDAB9', '#FFE4B5', '#FFFACD', '#F0E68C', '#98FB98', '#90EE90', '#7FFFD4'],
                avoidColors: ['#000080', '#4B0082', '#800080', '#483D8B', '#2F4F4F'],
                matchingColors: {
                    '#FFE4E1': ['#FFA07A', '#98FB98', '#FFFACD'],
                    '#FFA07A': ['#FFE4E1', '#90EE90', '#FFE4B5'],
                    '#98FB98': ['#FFE4E1', '#FFDAB9', '#F0E68C']
                }
            },
            summer: {
                name: '여름쿨톤',
                bestColors: ['#E6E6FA', '#B0C4DE', '#87CEEB', '#87CEFA', '#ADD8E6', '#B0E0E6', '#AFEEEE', '#E0FFFF', '#F0F8FF', '#F5F5DC'],
                avoidColors: ['#FF8C00', '#FF6347', '#FF4500', '#DC143C', '#8B0000'],
                matchingColors: {
                    '#E6E6FA': ['#B0C4DE', '#87CEEB', '#F0F8FF'],
                    '#B0C4DE': ['#E6E6FA', '#ADD8E6', '#E0FFFF'],
                    '#87CEEB': ['#E6E6FA', '#B0E0E6', '#F5F5DC']
                }
            },
            autumn: {
                name: '가을웜톤',
                bestColors: ['#DEB887', '#D2691E', '#CD853F', '#F4A460', '#BC8F8F', '#F5DEB3', '#FFE4C4', '#FFDEAD', '#D2B48C', '#8B4513'],
                avoidColors: ['#FF1493', '#FF69B4', '#FFC0CB', '#DDA0DD', '#DA70D6'],
                matchingColors: {
                    '#DEB887': ['#D2691E', '#8B4513', '#F5DEB3'],
                    '#D2691E': ['#DEB887', '#CD853F', '#D2B48C'],
                    '#F4A460': ['#BC8F8F', '#FFDEAD', '#8B4513']
                }
            },
            winter: {
                name: '겨울쿨톤',
                bestColors: ['#000080', '#191970', '#4169E1', '#0000FF', '#4682B4', '#5F9EA0', '#008B8B', '#2F4F4F', '#696969', '#FFFFFF'],
                avoidColors: ['#FFD700', '#FFA500', '#FF8C00', '#DAA520', '#B8860B'],
                matchingColors: {
                    '#000080': ['#FFFFFF', '#4682B4', '#696969'],
                    '#4169E1': ['#191970', '#5F9EA0', '#FFFFFF'],
                    '#2F4F4F': ['#008B8B', '#696969', '#4682B4']
                }
            }
        };

        let selectedSeason = localStorage.getItem('personalColor') || null;
        let uploadedImage = null;
        let uploadedImageBase64 = null;
        let imageCanvas = null;
        let imageContext = null;

        // 초기화
        document.addEventListener('DOMContentLoaded', () => {
            if (selectedSeason) {
                document.querySelector(`[data-season="${selectedSeason}"]`).classList.add('selected');
                checkReadyToAnalyze();
            }

            // 이벤트 리스너
            document.querySelectorAll('.pc-option').forEach(option => {
                option.addEventListener('click', selectPersonalColor);
            });

            document.getElementById('uploadSection').addEventListener('click', () => {
                document.getElementById('fileInput').click();
            });

            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
            document.getElementById('analyzeBtn').addEventListener('click', analyzeColors);
            document.getElementById('retryBtn').addEventListener('click', resetAnalysis);

            // 드래그 앤 드롭
            const uploadSection = document.getElementById('uploadSection');
            uploadSection.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadSection.style.borderColor = '#667eea';
            });

            uploadSection.addEventListener('dragleave', () => {
                uploadSection.style.borderColor = '#e0e0e0';
            });

            uploadSection.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadSection.style.borderColor = '#e0e0e0';
                
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type.startsWith('image/')) {
                    handleFile(files[0]);
                }
            });
        });

        function selectPersonalColor(e) {
            document.querySelectorAll('.pc-option').forEach(opt => opt.classList.remove('selected'));
            e.target.classList.add('selected');
            selectedSeason = e.target.dataset.season;
            localStorage.setItem('personalColor', selectedSeason);
            checkReadyToAnalyze();
        }

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                uploadedImage = new Image();
                uploadedImage.onload = () => {
                    displayImage(e.target.result);
                    prepareCanvas();
                };
                uploadedImage.src = e.target.result;
                
                // Google Vision API용 base64 저장 (data URL prefix 제거)
                uploadedImageBase64 = e.target.result.split(',')[1];
            };
            reader.readAsDataURL(file);
        }

        function displayImage(src) {
            const uploadSection = document.getElementById('uploadSection');
            uploadSection.classList.add('has-image');
            uploadSection.innerHTML = `<img src="${src}" class="image-preview" alt="Uploaded">`;
            checkReadyToAnalyze();
        }

        function prepareCanvas() {
            imageCanvas = document.createElement('canvas');
            imageContext = imageCanvas.getContext('2d');
            
            // 이미지 크기 조정 (성능 최적화)
            const maxSize = 400;
            let width = uploadedImage.width;
            let height = uploadedImage.height;
            
            if (width > height && width > maxSize) {
                height = (maxSize / width) * height;
                width = maxSize;
            } else if (height > maxSize) {
                width = (maxSize / height) * width;
                height = maxSize;
            }
            
            imageCanvas.width = width;
            imageCanvas.height = height;
            imageContext.drawImage(uploadedImage, 0, 0, width, height);
        }

        function checkReadyToAnalyze() {
            const btn = document.getElementById('analyzeBtn');
            btn.disabled = !(selectedSeason && uploadedImage);
        }

        async function analyzeColors() {
            // 로딩 화면 표시 (광고 포함)
            document.getElementById('loadingOverlay').style.display = 'flex';
            
            try {
                // Google Vision API 서버리스 함수 호출
                const colors = await extractColorsWithVisionAPI();
                
                // 3초 광고 시간 보장
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                const analysis = analyzePersonalColorMatch(colors);
                displayResults(analysis);
            } catch (error) {
                console.error('색상 분석 중 오류:', error);
                console.log('Canvas API로 폴백합니다.');
                
                // Google Vision API 실패시 Canvas API로 폴백
                const colors = extractColorsWithCanvas();
                const analysis = analyzePersonalColorMatch(colors);
                displayResults(analysis);
            } finally {
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }

        async function extractColorsWithVisionAPI() {
            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ imageBase64: uploadedImageBase64 })
                });
                
                if (!response.ok) {
                    throw new Error('서버 응답 오류');
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                console.log('Google Vision API로 추출된 색상:', data.colors);
                return data.colors;
            } catch (error) {
                console.error('Vision API 오류:', error);
                // 개발 중에는 Canvas API로 폴백
                console.log('Vision API를 사용할 수 없습니다. Canvas API를 사용합니다.');
                return extractColorsWithCanvas();
            }
        }

        function extractColorsWithCanvas() {
            const imageData = imageContext.getImageData(0, 0, imageCanvas.width, imageCanvas.height);
            const data = imageData.data;
            const colorMap = {};
            
            // 색상 샘플링 (성능 최적화를 위해 일부 픽셀만 분석)
            for (let i = 0; i < data.length; i += 40) { // 10픽셀마다 샘플링
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                
                // 색상을 그룹화 (비슷한 색상끼리)
                const key = `${Math.round(r/25)*25},${Math.round(g/25)*25},${Math.round(b/25)*25}`;
                colorMap[key] = (colorMap[key] || 0) + 1;
            }
            
            // 상위 5개 색상 추출
            const sortedColors = Object.entries(colorMap)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([color]) => {
                    const [r, g, b] = color.split(',').map(Number);
                    return rgbToHex(r, g, b);
                });
            
            console.log('Canvas API로 추출된 색상:', sortedColors);
            return sortedColors;
        }

        function rgbToHex(r, g, b) {
            return '#' + [r, g, b].map(x => {
                const hex = x.toString(16);
                return hex.length === 1 ? '0' + hex : hex;
            }).join('').toUpperCase();
        }

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }

        function colorDistance(hex1, hex2) {
            const c1 = hexToRgb(hex1);
            const c2 = hexToRgb(hex2);
            
            if (!c1 || !c2) return 1000;
            
            // 색상 거리 계산 (Euclidean distance)
            return Math.sqrt(
                Math.pow(c1.r - c2.r, 2) +
                Math.pow(c1.g - c2.g, 2) +
                Math.pow(c1.b - c2.b, 2)
            );
        }

        function analyzePersonalColorMatch(detectedColors) {
            const seasonData = personalColorDB[selectedSeason];
            let totalMatchScore = 0;
            const colorScores = [];
            
            // 각 감지된 색상에 대해 개별 점수 계산
            detectedColors.forEach(color => {
                let minBestDistance = 1000;
                let minAvoidDistance = 1000;
                let matchScore = 0;
                let avoidScore = 0;
                
                // 베스트 컬러와의 거리
                seasonData.bestColors.forEach(bestColor => {
                    const distance = colorDistance(color, bestColor);
                    minBestDistance = Math.min(minBestDistance, distance);
                });
                
                // 피해야 할 색상과의 거리
                seasonData.avoidColors.forEach(avoidColor => {
                    const distance = colorDistance(color, avoidColor);
                    minAvoidDistance = Math.min(minAvoidDistance, distance);
                });
                
                // 개별 색상 점수 계산
                if (minBestDistance < 100) {
                    matchScore = (100 - minBestDistance);
                }
                
                if (minAvoidDistance < 100) {
                    avoidScore = (100 - minAvoidDistance);
                }
                
                const individualScore = Math.max(0, Math.min(100, matchScore - avoidScore * 0.5));
                
                colorScores.push({
                    color: color,
                    score: Math.round(individualScore),
                    matchDistance: minBestDistance,
                    avoidDistance: minAvoidDistance
                });
                
                totalMatchScore += individualScore;
            });
            
            // 전체 평균 점수 계산
            const finalScore = Math.round(totalMatchScore / detectedColors.length);
            
            // 추천 색상 선택
            const recommendedColors = [];
            const mainColor = detectedColors[0];
            
            // 메인 색상과 잘 어울리는 퍼스널컬러 찾기
            seasonData.bestColors.forEach(color => {
                if (colorDistance(mainColor, color) < 200) {
                    recommendedColors.push(color);
                }
            });
            
            // 최대 4개까지만 추천
            const finalRecommended = recommendedColors.slice(0, 4);
            
            // 추천 색상이 없으면 기본 베스트 컬러 추천
            if (finalRecommended.length === 0) {
                finalRecommended.push(...seasonData.bestColors.slice(0, 4));
            }
            
            return {
                score: finalScore,
                detectedColors: detectedColors,
                colorScores: colorScores,
                recommendedColors: finalRecommended,
                seasonName: seasonData.name
            };
        }

        function displayResults(analysis) {
            const resultSection = document.getElementById('resultSection');
            const matchScore = document.getElementById('matchScore');
            const matchMessage = document.getElementById('matchMessage');
            const detectedColorsDiv = document.getElementById('detectedColors');
            const recommendedColorsDiv = document.getElementById('recommendedColors');
            
            // 점수 표시
            matchScore.textContent = `${analysis.score}%`;
            
            // 점수에 따른 메시지와 색상
            if (analysis.score >= 70) {
                matchScore.className = 'match-score good';
                matchMessage.textContent = '잘 어울려요! 👍';
            } else if (analysis.score >= 40) {
                matchScore.className = 'match-score okay';
                matchMessage.textContent = '고민해보세요 🤔';
            } else {
                matchScore.className = 'match-score bad';
                matchMessage.textContent = '추천하지 않아요 😕';
            }
            
            // 감지된 색상 표시 (개별 점수 포함)
            detectedColorsDiv.innerHTML = '';
            analysis.colorScores.forEach((colorData, index) => {
                const chip = createColorChip(colorData.color, colorData.score);
                chip.addEventListener('click', () => {
                    showIndividualColorInfo(colorData, chip);
                });
                detectedColorsDiv.appendChild(chip);
                
                // 첫 번째 색상 자동 선택
                if (index === 0) {
                    setTimeout(() => {
                        chip.click();
                    }, 100);
                }
            });
            
            // 추천 색상 표시
            recommendedColorsDiv.innerHTML = '';
            analysis.recommendedColors.forEach(color => {
                const chip = createColorChip(color);
                recommendedColorsDiv.appendChild(chip);
            });
            
            // 결과 섹션 표시
            resultSection.style.display = 'block';
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('analyzeBtn').style.display = 'none';
        }

        function createColorChip(color, score = null) {
            const chip = document.createElement('div');
            chip.className = 'color-chip';
            if (score !== null) {
                chip.classList.add('detected');
            }
            chip.style.background = color;
            
            const hex = document.createElement('div');
            hex.className = 'color-hex';
            hex.textContent = color;
            chip.appendChild(hex);
            
            // 점수가 있으면 배지 추가
            if (score !== null) {
                const badge = document.createElement('div');
                badge.className = 'color-match-badge';
                badge.textContent = `${score}%`;
                
                if (score >= 70) {
                    badge.classList.add('good');
                } else if (score >= 40) {
                    badge.classList.add('okay');
                } else {
                    badge.classList.add('bad');
                }
                
                chip.appendChild(badge);
            }
            
            return chip;
        }

        function showIndividualColorInfo(colorData, chipElement) {
            // 기존 선택 제거
            document.querySelectorAll('.color-chip').forEach(chip => {
                chip.classList.remove('selected');
            });
            
            // 현재 선택 표시
            chipElement.classList.add('selected');
            
            // 개별 색상 정보 표시
            const infoDiv = document.getElementById('individualColorInfo');
            const sampleDiv = document.getElementById('colorInfoSample');
            const scoreDiv = document.getElementById('colorInfoScore');
            const hexDiv = document.getElementById('colorInfoHex');
            const textDiv = document.getElementById('colorInfoText');
            
            sampleDiv.style.background = colorData.color;
            scoreDiv.textContent = `${colorData.score}%`;
            hexDiv.textContent = colorData.color;
            
            // 점수에 따른 스타일과 메시지
            if (colorData.score >= 70) {
                scoreDiv.className = 'color-info-score good';
                textDiv.textContent = `이 색상은 ${personalColorDB[selectedSeason].name}과 아주 잘 어울립니다! 자신있게 선택하세요.`;
            } else if (colorData.score >= 40) {
                scoreDiv.className = 'color-info-score okay';
                textDiv.textContent = `이 색상은 ${personalColorDB[selectedSeason].name}과 무난하게 어울립니다. 다른 아이템과의 조합을 고려해보세요.`;
            } else {
                scoreDiv.className = 'color-info-score bad';
                textDiv.textContent = `이 색상은 ${personalColorDB[selectedSeason].name}과 잘 어울리지 않습니다. 다른 색상을 고려해보는 것이 좋겠어요.`;
            }
            
            infoDiv.classList.add('show');
        }

        function resetAnalysis() {
            // 초기화
            uploadedImage = null;
            uploadedImageBase64 = null;
            imageCanvas = null;
            imageContext = null;
            
            // UI 초기화
            const uploadSection = document.getElementById('uploadSection');
            uploadSection.classList.remove('has-image');
            uploadSection.innerHTML = `
                <div class="upload-icon">📸</div>
                <div class="upload-text">옷 사진을 업로드하세요</div>
                <div class="upload-subtext">클릭하거나 드래그해서 업로드</div>
            `;
            
            document.getElementById('fileInput').value = '';
            document.getElementById('resultSection').style.display = 'none';
            document.getElementById('individualColorInfo').classList.remove('show');
            uploadSection.style.display = 'block';
            document.getElementById('analyzeBtn').style.display = 'block';
            checkReadyToAnalyze();
        }
    </script>
</body>
</html>