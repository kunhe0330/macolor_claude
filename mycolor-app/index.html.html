<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyColor - í¼ìŠ¤ë„ì»¬ëŸ¬ ë§¤ì¹­ ì„œë¹„ìŠ¤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding-top: 20px;
        }

        .logo {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .subtitle {
            font-size: 14px;
            opacity: 0.95;
        }

        .powered-by {
            font-size: 11px;
            opacity: 0.8;
            margin-top: 5px;
        }

        .main-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .personal-color-selector {
            margin-bottom: 30px;
        }

        .pc-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 12px;
            font-weight: 500;
        }

        .pc-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .pc-option {
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
        }

        .pc-option:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .pc-option.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }

        .spring { background: linear-gradient(45deg, #FFE4E1, #FFA07A); }
        .summer { background: linear-gradient(45deg, #E6E6FA, #B0C4DE); }
        .autumn { background: linear-gradient(45deg, #DEB887, #D2691E); }
        .winter { background: linear-gradient(45deg, #F0F8FF, #4682B4); }

        .pc-option.selected.spring,
        .pc-option.selected.summer,
        .pc-option.selected.autumn,
        .pc-option.selected.winter {
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        .upload-section {
            text-align: center;
            padding: 40px 20px;
            border: 2px dashed #e0e0e0;
            border-radius: 16px;
            background: #fafafa;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-section:hover {
            border-color: #667eea;
            background: #f5f5ff;
        }

        .upload-section.has-image {
            padding: 20px;
            border-style: solid;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .upload-text {
            color: #666;
            font-size: 16px;
            margin-bottom: 8px;
        }

        .upload-subtext {
            color: #999;
            font-size: 14px;
        }

        #fileInput {
            display: none;
        }

        .image-preview {
            max-width: 100%;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .analyze-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .analyze-btn:hover {
            transform: translateY(-2px);
        }

        .analyze-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .loading-content {
            text-align: center;
            color: white;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .ad-placeholder {
            background: #f0f0f0;
            border: 2px dashed #ccc;
            padding: 40px 20px;
            margin: 20px 0;
            text-align: center;
            color: #999;
            border-radius: 8px;
        }

        .result-section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .result-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .match-score {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .match-score.good { color: #4CAF50; }
        .match-score.okay { color: #FF9800; }
        .match-score.bad { color: #f44336; }

        .match-message {
            font-size: 18px;
            color: #666;
            margin-bottom: 20px;
        }

        .color-analysis {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #333;
        }

        .color-palette {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .color-chip {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .color-chip:hover {
            transform: scale(1.1);
        }

        .color-chip.selected {
            transform: scale(1.15);
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
            border: 3px solid #667eea;
        }

        .color-chip.detected {
            width: 70px;
            height: 70px;
        }

        .color-chip.detected .color-match-badge {
            width: 32px;
            height: 32px;
            font-size: 11px;
        }

        .color-hex {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #666;
            white-space: nowrap;
        }

        .color-match-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: white;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .color-match-badge.good {
            color: #4CAF50;
            border: 2px solid #4CAF50;
        }

        .color-match-badge.okay {
            color: #FF9800;
            border: 2px solid #FF9800;
        }

        .color-match-badge.bad {
            color: #f44336;
            border: 2px solid #f44336;
        }

        .individual-color-info {
            background: #f8f9ff;
            padding: 16px;
            border-radius: 12px;
            margin-top: 20px;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .individual-color-info.show {
            display: block;
        }

        .color-info-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .color-info-sample {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .color-info-score {
            font-size: 24px;
            font-weight: bold;
        }

        .color-info-score.good { color: #4CAF50; }
        .color-info-score.okay { color: #FF9800; }
        .color-info-score.bad { color: #f44336; }

        .color-info-text {
            font-size: 14px;
            color: #666;
            line-height: 1.5;
        }

        .recommendation {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .retry-btn {
            width: 100%;
            padding: 14px;
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .retry-btn:hover {
            background: #667eea;
            color: white;
        }

        .ai-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .main-card {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">ğŸ¨ MyColor</div>
            <div class="subtitle">ë‹¹ì‹ ì˜ í¼ìŠ¤ë„ì»¬ëŸ¬ì™€ ì˜ ì–´ìš¸ë¦¬ëŠ” ì˜·ì„ ì°¾ì•„ë“œë ¤ìš”</div>
            <div class="powered-by">âœ¨ AI ê¸°ë°˜ ì •ë°€ ìƒ‰ìƒ ë¶„ì„</div>
        </header>

        <div class="main-card">
            <div class="personal-color-selector">
                <div class="pc-label">ë‚˜ì˜ í¼ìŠ¤ë„ì»¬ëŸ¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</div>
                <div class="pc-options">
                    <div class="pc-option spring" data-season="spring">ğŸŒ¸ ë´„ì›œí†¤</div>
                    <div class="pc-option summer" data-season="summer">ğŸ’™ ì—¬ë¦„ì¿¨í†¤</div>
                    <div class="pc-option autumn" data-season="autumn">ğŸ‚ ê°€ì„ì›œí†¤</div>
                    <div class="pc-option winter" data-season="winter">â„ï¸ ê²¨ìš¸ì¿¨í†¤</div>
                </div>
            </div>

            <div class="upload-section" id="uploadSection">
                <div class="upload-icon">ğŸ“¸</div>
                <div class="upload-text">ì˜· ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</div>
                <div class="upload-subtext">í´ë¦­í•˜ê±°ë‚˜ ë“œë˜ê·¸í•´ì„œ ì—…ë¡œë“œ</div>
                <input type="file" id="fileInput" accept="image/*">
            </div>

            <button class="analyze-btn" id="analyzeBtn" disabled>ìƒ‰ìƒ ë¶„ì„í•˜ê¸°</button>

            <div class="result-section" id="resultSection">
                <div class="ai-badge">ğŸ¤– AI ë¶„ì„ ì™„ë£Œ</div>
                <div class="result-header">
                    <div class="match-score" id="matchScore">85%</div>
                    <div class="match-message" id="matchMessage">ì˜ ì–´ìš¸ë ¤ìš”!</div>
                    <div style="font-size: 12px; color: #999; margin-top: 8px;">ì „ì²´ í‰ê·  ë§¤ì¹­ë„</div>
                </div>

                <div class="color-analysis">
                    <div class="section-title">ê°ì§€ëœ ìƒ‰ìƒ (í´ë¦­í•˜ì—¬ ê°œë³„ ì ìˆ˜ í™•ì¸)</div>
                    <div class="color-palette" id="detectedColors"></div>
                    <div class="individual-color-info" id="individualColorInfo">
                        <div class="color-info-header">
                            <div class="color-info-sample" id="colorInfoSample"></div>
                            <div>
                                <div class="color-info-score" id="colorInfoScore">85%</div>
                                <div style="font-size: 12px; color: #999;" id="colorInfoHex">#FFFFFF</div>
                            </div>
                        </div>
                        <div class="color-info-text" id="colorInfoText">
                            ì´ ìƒ‰ìƒì€ ë‹¹ì‹ ì˜ í¼ìŠ¤ë„ì»¬ëŸ¬ì™€ ì˜ ì–´ìš¸ë¦½ë‹ˆë‹¤.
                        </div>
                    </div>
                </div>

                <div class="recommendation">
                    <div class="section-title">âœ¨ ì´ ìƒ‰ìƒê³¼ ì˜ ì–´ìš¸ë¦¬ëŠ” ë‹¹ì‹ ì˜ í¼ìŠ¤ë„ì»¬ëŸ¬</div>
                    <div class="color-palette" id="recommendedColors"></div>
                </div>

                <button class="retry-btn" id="retryBtn">ë‹¤ë¥¸ ì˜· ë¶„ì„í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div style="font-size: 18px; margin-bottom: 20px;">AIê°€ ìƒ‰ìƒì„ ë¶„ì„ì¤‘ì…ë‹ˆë‹¤...</div>
            <div style="font-size: 12px; color: #aaa; margin-bottom: 10px;">Google Vision AI ì‚¬ìš© ì¤‘</div>
            <div class="ad-placeholder">
                <div style="font-size: 14px;">[ ê´‘ê³  ì˜ì—­ ]</div>
                <div style="font-size: 12px; margin-top: 10px;">Google AdSense</div>
            </div>
        </div>
    </div>

    <script>
        // API ì—”ë“œí¬ì¸íŠ¸ ì„¤ì •
        const API_ENDPOINT = '/api/analyze-colors'; // Vercel ì„œë²„ë¦¬ìŠ¤ í•¨ìˆ˜ ì—”ë“œí¬ì¸íŠ¸
        // ê°œë°œ ì¤‘ì—ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì‚¬ìš©:
        // const API_ENDPOINT = 'http://localhost:3000/api/analyze-colors';
        
        // í¼ìŠ¤ë„ì»¬ëŸ¬ ë°ì´í„°ë² ì´ìŠ¤
        const personalColorDB = {
            spring: {
                name: 'ë´„ì›œí†¤',
                bestColors: ['#FFE4E1', '#FFA07A', '#FFB6C1', '#FFDAB9', '#FFE4B5', '#FFFACD', '#F0E68C', '#98FB98', '#90EE90', '#7FFFD4'],
                avoidColors: ['#000080', '#4B0082', '#800080', '#483D8B', '#2F4F4F'],
                matchingColors: {
                    '#FFE4E1': ['#FFA07A', '#98FB98', '#FFFACD'],
                    '#FFA07A': ['#FFE4E1', '#90EE90', '#FFE4B5'],
                    '#98FB98': ['#FFE4E1', '#FFDAB9', '#F0E68C']
                }
            },
            summer: {
                name: 'ì—¬ë¦„ì¿¨í†¤',
                bestColors: ['#E6E6FA', '#B0C4DE', '#87CEEB', '#87CEFA', '#ADD8E6', '#B0E0E6', '#AFEEEE', '#E0FFFF', '#F0F8FF', '#F5F5DC'],
                avoidColors: ['#FF8C00', '#FF6347', '#FF4500', '#DC143C', '#8B0000'],
                matchingColors: {
                    '#E6E6FA': ['#B0C4DE', '#87CEEB', '#F0F8FF'],
                    '#B0C4DE': ['#E6E6FA', '#ADD8E6', '#E0FFFF'],
                    '#87CEEB': ['#E6E6FA', '#B0E0E6', '#F5F5DC']
                }
            },
            autumn: {
                name: 'ê°€ì„ì›œí†¤',
                bestColors: ['#DEB887', '#D2691E', '#CD853F', '#F4A460', '#BC8F8F', '#F5DEB3', '#FFE4C4', '#FFDEAD', '#D2B48C', '#8B4513'],
                avoidColors: ['#FF1493', '#FF69B4', '#FFC0CB', '#DDA0DD', '#DA70D6'],
                matchingColors: {
                    '#DEB887': ['#D2691E', '#8B4513', '#F5DEB3'],
                    '#D2691E': ['#DEB887', '#CD853F', '#D2B48C'],
                    '#F4A460': ['#BC8F8F', '#FFDEAD', '#8B4513']
                }
            },
            winter: {
                name: 'ê²¨ìš¸ì¿¨í†¤',
                bestColors: ['#000080', '#191970', '#4169E1', '#0000FF', '#4682B4', '#5F9EA0', '#008B8B', '#2F4F4F', '#696969', '#FFFFFF'],
                avoidColors: ['#FFD700', '#FFA500', '#FF8C00', '#DAA520', '#B8860B'],
                matchingColors: {
                    '#000080': ['#FFFFFF', '#4682B4', '#696969'],
                    '#4169E1': ['#191970', '#5F9EA0', '#FFFFFF'],
                    '#2F4F4F': ['#008B8B', '#696969', '#4682B4']
                }
            }
        };

        let selectedSeason = localStorage.getItem('personalColor') || null;
        let uploadedImage = null;
        let uploadedImageBase64 = null;
        let imageCanvas = null;
        let imageContext = null;

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            if (selectedSeason) {
                document.querySelector(`[data-season="${selectedSeason}"]`).classList.add('selected');
                checkReadyToAnalyze();
            }

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            document.querySelectorAll('.pc-option').forEach(option => {
                option.addEventListener('click', selectPersonalColor);
            });

            document.getElementById('uploadSection').addEventListener('click', () => {
                document.getElementById('fileInput').click();
            });

            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
            document.getElementById('analyzeBtn').addEventListener('click', analyzeColors);
            document.getElementById('retryBtn').addEventListener('click', resetAnalysis);

            // ë“œë˜ê·¸ ì•¤ ë“œë¡­
            const uploadSection = document.getElementById('uploadSection');
            uploadSection.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadSection.style.borderColor = '#667eea';
            });

            uploadSection.addEventListener('dragleave', () => {
                uploadSection.style.borderColor = '#e0e0e0';
            });

            uploadSection.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadSection.style.borderColor = '#e0e0e0';
                
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type.startsWith('image/')) {
                    handleFile(files[0]);
                }
            });
        });

        function selectPersonalColor(e) {
            document.querySelectorAll('.pc-option').forEach(opt => opt.classList.remove('selected'));
            e.target.classList.add('selected');
            selectedSeason = e.target.dataset.season;
            localStorage.setItem('personalColor', selectedSeason);
            checkReadyToAnalyze();
        }

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                uploadedImage = new Image();
                uploadedImage.onload = () => {
                    displayImage(e.target.result);
                    prepareCanvas();
                };
                uploadedImage.src = e.target.result;
                
                // Google Vision APIìš© base64 ì €ì¥ (data URL prefix ì œê±°)
                uploadedImageBase64 = e.target.result.split(',')[1];
            };
            reader.readAsDataURL(file);
        }

        function displayImage(src) {
            const uploadSection = document.getElementById('uploadSection');
            uploadSection.classList.add('has-image');
            uploadSection.innerHTML = `<img src="${src}" class="image-preview" alt="Uploaded">`;
            checkReadyToAnalyze();
        }

        function prepareCanvas() {
            imageCanvas = document.createElement('canvas');
            imageContext = imageCanvas.getContext('2d');
            
            // ì´ë¯¸ì§€ í¬ê¸° ì¡°ì • (ì„±ëŠ¥ ìµœì í™”)
            const maxSize = 400;
            let width = uploadedImage.width;
            let height = uploadedImage.height;
            
            if (width > height && width > maxSize) {
                height = (maxSize / width) * height;
                width = maxSize;
            } else if (height > maxSize) {
                width = (maxSize / height) * width;
                height = maxSize;
            }
            
            imageCanvas.width = width;
            imageCanvas.height = height;
            imageContext.drawImage(uploadedImage, 0, 0, width, height);
        }

        function checkReadyToAnalyze() {
            const btn = document.getElementById('analyzeBtn');
            btn.disabled = !(selectedSeason && uploadedImage);
        }

        async function analyzeColors() {
            // ë¡œë”© í™”ë©´ í‘œì‹œ (ê´‘ê³  í¬í•¨)
            document.getElementById('loadingOverlay').style.display = 'flex';
            
            try {
                // Google Vision API ì„œë²„ë¦¬ìŠ¤ í•¨ìˆ˜ í˜¸ì¶œ
                const colors = await extractColorsWithVisionAPI();
                
                // 3ì´ˆ ê´‘ê³  ì‹œê°„ ë³´ì¥
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                const analysis = analyzePersonalColorMatch(colors);
                displayResults(analysis);
            } catch (error) {
                console.error('ìƒ‰ìƒ ë¶„ì„ ì¤‘ ì˜¤ë¥˜:', error);
                console.log('Canvas APIë¡œ í´ë°±í•©ë‹ˆë‹¤.');
                
                // Google Vision API ì‹¤íŒ¨ì‹œ Canvas APIë¡œ í´ë°±
                const colors = extractColorsWithCanvas();
                const analysis = analyzePersonalColorMatch(colors);
                displayResults(analysis);
            } finally {
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }

        async function extractColorsWithVisionAPI() {
            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ imageBase64: uploadedImageBase64 })
                });
                
                if (!response.ok) {
                    throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜');
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                console.log('Google Vision APIë¡œ ì¶”ì¶œëœ ìƒ‰ìƒ:', data.colors);
                return data.colors;
            } catch (error) {
                console.error('Vision API ì˜¤ë¥˜:', error);
                // ê°œë°œ ì¤‘ì—ëŠ” Canvas APIë¡œ í´ë°±
                console.log('Vision APIë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Canvas APIë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.');
                return extractColorsWithCanvas();
            }
        }

        function extractColorsWithCanvas() {
            const imageData = imageContext.getImageData(0, 0, imageCanvas.width, imageCanvas.height);
            const data = imageData.data;
            const colorMap = {};
            
            // ìƒ‰ìƒ ìƒ˜í”Œë§ (ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•´ ì¼ë¶€ í”½ì…€ë§Œ ë¶„ì„)
            for (let i = 0; i < data.length; i += 40) { // 10í”½ì…€ë§ˆë‹¤ ìƒ˜í”Œë§
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                
                // ìƒ‰ìƒì„ ê·¸ë£¹í™” (ë¹„ìŠ·í•œ ìƒ‰ìƒë¼ë¦¬)
                const key = `${Math.round(r/25)*25},${Math.round(g/25)*25},${Math.round(b/25)*25}`;
                colorMap[key] = (colorMap[key] || 0) + 1;
            }
            
            // ìƒìœ„ 5ê°œ ìƒ‰ìƒ ì¶”ì¶œ
            const sortedColors = Object.entries(colorMap)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([color]) => {
                    const [r, g, b] = color.split(',').map(Number);
                    return rgbToHex(r, g, b);
                });
            
            console.log('Canvas APIë¡œ ì¶”ì¶œëœ ìƒ‰ìƒ:', sortedColors);
            return sortedColors;
        }

        function rgbToHex(r, g, b) {
            return '#' + [r, g, b].map(x => {
                const hex = x.toString(16);
                return hex.length === 1 ? '0' + hex : hex;
            }).join('').toUpperCase();
        }

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }

        function colorDistance(hex1, hex2) {
            const c1 = hexToRgb(hex1);
            const c2 = hexToRgb(hex2);
            
            if (!c1 || !c2) return 1000;
            
            // ìƒ‰ìƒ ê±°ë¦¬ ê³„ì‚° (Euclidean distance)
            return Math.sqrt(
                Math.pow(c1.r - c2.r, 2) +
                Math.pow(c1.g - c2.g, 2) +
                Math.pow(c1.b - c2.b, 2)
            );
        }

        function analyzePersonalColorMatch(detectedColors) {
            const seasonData = personalColorDB[selectedSeason];
            let totalMatchScore = 0;
            const colorScores = [];
            
            // ê° ê°ì§€ëœ ìƒ‰ìƒì— ëŒ€í•´ ê°œë³„ ì ìˆ˜ ê³„ì‚°
            detectedColors.forEach(color => {
                let minBestDistance = 1000;
                let minAvoidDistance = 1000;
                let matchScore = 0;
                let avoidScore = 0;
                
                // ë² ìŠ¤íŠ¸ ì»¬ëŸ¬ì™€ì˜ ê±°ë¦¬
                seasonData.bestColors.forEach(bestColor => {
                    const distance = colorDistance(color, bestColor);
                    minBestDistance = Math.min(minBestDistance, distance);
                });
                
                // í”¼í•´ì•¼ í•  ìƒ‰ìƒê³¼ì˜ ê±°ë¦¬
                seasonData.avoidColors.forEach(avoidColor => {
                    const distance = colorDistance(color, avoidColor);
                    minAvoidDistance = Math.min(minAvoidDistance, distance);
                });
                
                // ê°œë³„ ìƒ‰ìƒ ì ìˆ˜ ê³„ì‚°
                if (minBestDistance < 100) {
                    matchScore = (100 - minBestDistance);
                }
                
                if (minAvoidDistance < 100) {
                    avoidScore = (100 - minAvoidDistance);
                }
                
                const individualScore = Math.max(0, Math.min(100, matchScore - avoidScore * 0.5));
                
                colorScores.push({
                    color: color,
                    score: Math.round(individualScore),
                    matchDistance: minBestDistance,
                    avoidDistance: minAvoidDistance
                });
                
                totalMatchScore += individualScore;
            });
            
            // ì „ì²´ í‰ê·  ì ìˆ˜ ê³„ì‚°
            const finalScore = Math.round(totalMatchScore / detectedColors.length);
            
            // ì¶”ì²œ ìƒ‰ìƒ ì„ íƒ
            const recommendedColors = [];
            const mainColor = detectedColors[0];
            
            // ë©”ì¸ ìƒ‰ìƒê³¼ ì˜ ì–´ìš¸ë¦¬ëŠ” í¼ìŠ¤ë„ì»¬ëŸ¬ ì°¾ê¸°
            seasonData.bestColors.forEach(color => {
                if (colorDistance(mainColor, color) < 200) {
                    recommendedColors.push(color);
                }
            });
            
            // ìµœëŒ€ 4ê°œê¹Œì§€ë§Œ ì¶”ì²œ
            const finalRecommended = recommendedColors.slice(0, 4);
            
            // ì¶”ì²œ ìƒ‰ìƒì´ ì—†ìœ¼ë©´ ê¸°ë³¸ ë² ìŠ¤íŠ¸ ì»¬ëŸ¬ ì¶”ì²œ
            if (finalRecommended.length === 0) {
                finalRecommended.push(...seasonData.bestColors.slice(0, 4));
            }
            
            return {
                score: finalScore,
                detectedColors: detectedColors,
                colorScores: colorScores,
                recommendedColors: finalRecommended,
                seasonName: seasonData.name
            };
        }

        function displayResults(analysis) {
            const resultSection = document.getElementById('resultSection');
            const matchScore = document.getElementById('matchScore');
            const matchMessage = document.getElementById('matchMessage');
            const detectedColorsDiv = document.getElementById('detectedColors');
            const recommendedColorsDiv = document.getElementById('recommendedColors');
            
            // ì ìˆ˜ í‘œì‹œ
            matchScore.textContent = `${analysis.score}%`;
            
            // ì ìˆ˜ì— ë”°ë¥¸ ë©”ì‹œì§€ì™€ ìƒ‰ìƒ
            if (analysis.score >= 70) {
                matchScore.className = 'match-score good';
                matchMessage.textContent = 'ì˜ ì–´ìš¸ë ¤ìš”! ğŸ‘';
            } else if (analysis.score >= 40) {
                matchScore.className = 'match-score okay';
                matchMessage.textContent = 'ê³ ë¯¼í•´ë³´ì„¸ìš” ğŸ¤”';
            } else {
                matchScore.className = 'match-score bad';
                matchMessage.textContent = 'ì¶”ì²œí•˜ì§€ ì•Šì•„ìš” ğŸ˜•';
            }
            
            // ê°ì§€ëœ ìƒ‰ìƒ í‘œì‹œ (ê°œë³„ ì ìˆ˜ í¬í•¨)
            detectedColorsDiv.innerHTML = '';
            analysis.colorScores.forEach((colorData, index) => {
                const chip = createColorChip(colorData.color, colorData.score);
                chip.addEventListener('click', () => {
                    showIndividualColorInfo(colorData, chip);
                });
                detectedColorsDiv.appendChild(chip);
                
                // ì²« ë²ˆì§¸ ìƒ‰ìƒ ìë™ ì„ íƒ
                if (index === 0) {
                    setTimeout(() => {
                        chip.click();
                    }, 100);
                }
            });
            
            // ì¶”ì²œ ìƒ‰ìƒ í‘œì‹œ
            recommendedColorsDiv.innerHTML = '';
            analysis.recommendedColors.forEach(color => {
                const chip = createColorChip(color);
                recommendedColorsDiv.appendChild(chip);
            });
            
            // ê²°ê³¼ ì„¹ì…˜ í‘œì‹œ
            resultSection.style.display = 'block';
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('analyzeBtn').style.display = 'none';
        }

        function createColorChip(color, score = null) {
            const chip = document.createElement('div');
            chip.className = 'color-chip';
            if (score !== null) {
                chip.classList.add('detected');
            }
            chip.style.background = color;
            
            const hex = document.createElement('div');
            hex.className = 'color-hex';
            hex.textContent = color;
            chip.appendChild(hex);
            
            // ì ìˆ˜ê°€ ìˆìœ¼ë©´ ë°°ì§€ ì¶”ê°€
            if (score !== null) {
                const badge = document.createElement('div');
                badge.className = 'color-match-badge';
                badge.textContent = `${score}%`;
                
                if (score >= 70) {
                    badge.classList.add('good');
                } else if (score >= 40) {
                    badge.classList.add('okay');
                } else {
                    badge.classList.add('bad');
                }
                
                chip.appendChild(badge);
            }
            
            return chip;
        }

        function showIndividualColorInfo(colorData, chipElement) {
            // ê¸°ì¡´ ì„ íƒ ì œê±°
            document.querySelectorAll('.color-chip').forEach(chip => {
                chip.classList.remove('selected');
            });
            
            // í˜„ì¬ ì„ íƒ í‘œì‹œ
            chipElement.classList.add('selected');
            
            // ê°œë³„ ìƒ‰ìƒ ì •ë³´ í‘œì‹œ
            const infoDiv = document.getElementById('individualColorInfo');
            const sampleDiv = document.getElementById('colorInfoSample');
            const scoreDiv = document.getElementById('colorInfoScore');
            const hexDiv = document.getElementById('colorInfoHex');
            const textDiv = document.getElementById('colorInfoText');
            
            sampleDiv.style.background = colorData.color;
            scoreDiv.textContent = `${colorData.score}%`;
            hexDiv.textContent = colorData.color;
            
            // ì ìˆ˜ì— ë”°ë¥¸ ìŠ¤íƒ€ì¼ê³¼ ë©”ì‹œì§€
            if (colorData.score >= 70) {
                scoreDiv.className = 'color-info-score good';
                textDiv.textContent = `ì´ ìƒ‰ìƒì€ ${personalColorDB[selectedSeason].name}ê³¼ ì•„ì£¼ ì˜ ì–´ìš¸ë¦½ë‹ˆë‹¤! ìì‹ ìˆê²Œ ì„ íƒí•˜ì„¸ìš”.`;
            } else if (colorData.score >= 40) {
                scoreDiv.className = 'color-info-score okay';
                textDiv.textContent = `ì´ ìƒ‰ìƒì€ ${personalColorDB[selectedSeason].name}ê³¼ ë¬´ë‚œí•˜ê²Œ ì–´ìš¸ë¦½ë‹ˆë‹¤. ë‹¤ë¥¸ ì•„ì´í…œê³¼ì˜ ì¡°í•©ì„ ê³ ë ¤í•´ë³´ì„¸ìš”.`;
            } else {
                scoreDiv.className = 'color-info-score bad';
                textDiv.textContent = `ì´ ìƒ‰ìƒì€ ${personalColorDB[selectedSeason].name}ê³¼ ì˜ ì–´ìš¸ë¦¬ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ìƒ‰ìƒì„ ê³ ë ¤í•´ë³´ëŠ” ê²ƒì´ ì¢‹ê² ì–´ìš”.`;
            }
            
            infoDiv.classList.add('show');
        }

        function resetAnalysis() {
            // ì´ˆê¸°í™”
            uploadedImage = null;
            uploadedImageBase64 = null;
            imageCanvas = null;
            imageContext = null;
            
            // UI ì´ˆê¸°í™”
            const uploadSection = document.getElementById('uploadSection');
            uploadSection.classList.remove('has-image');
            uploadSection.innerHTML = `
                <div class="upload-icon">ğŸ“¸</div>
                <div class="upload-text">ì˜· ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</div>
                <div class="upload-subtext">í´ë¦­í•˜ê±°ë‚˜ ë“œë˜ê·¸í•´ì„œ ì—…ë¡œë“œ</div>
            `;
            
            document.getElementById('fileInput').value = '';
            document.getElementById('resultSection').style.display = 'none';
            document.getElementById('individualColorInfo').classList.remove('show');
            uploadSection.style.display = 'block';
            document.getElementById('analyzeBtn').style.display = 'block';
            checkReadyToAnalyze();
        }
    </script>
</body>
</html>